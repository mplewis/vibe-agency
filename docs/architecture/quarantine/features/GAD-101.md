# GAD-101: Multi-Source Configuration Loading

**Status:** Phase 1 Complete (Documentation)
**Parent:** GAD-100 Configuration & Environment Management
**Created:** 2025-11-17
**Last Updated:** 2025-11-17

---

## Overview

GAD-101 defines the multi-source configuration loading strategy for vibe-agency. This document specifies how configuration data is loaded, merged, and prioritized from multiple sources.

---

## Configuration Sources

### Source Priority (Highest to Lowest)

1. **Environment Variables** (Highest priority)
2. **Environment-Specific YAML** (`config/{env}.yaml`)
3. **Base YAML** (`config/base.yaml`)
4. **State Files** (JSON manifests)
5. **Defaults** (Hardcoded in code)

---

## Source Definitions

### 1. Environment Variables

**Purpose:** Runtime overrides for deployment-specific settings

**Format:**
```bash
VIBE_SYSTEM_DEBUG=true
VIBE_LOG_LEVEL=DEBUG
VIBE_DATABASE_URL=postgresql://localhost/vibe_dev
```

**Naming Convention:**
- Prefix: `VIBE_`
- Nested config: `VIBE_SECTION_KEY=value`
- Example: `VIBE_API_PORT=8080` maps to `config.api.port`

**Loading:**
```python
import os
from phoenix_config import UniversalConfig

config = UniversalConfig.from_yaml("config/base.yaml")

# Environment variables override YAML
if "VIBE_API_PORT" in os.environ:
    config.api.port = int(os.environ["VIBE_API_PORT"])
```

---

### 2. Environment-Specific YAML

**Purpose:** Environment-specific settings (dev/staging/prod)

**Files:**
- `config/dev.yaml` - Development environment
- `config/staging.yaml` - Staging environment
- `config/prod.yaml` - Production environment
- `config/test.yaml` - Testing environment

**Format:**
```yaml
# config/dev.yaml
system:
  debug: true
  log_level: DEBUG

database:
  url: sqlite:///dev.db
  echo: true

api:
  debug: true
  reload: true
```

**Loading:**
```python
env = os.getenv("VIBE_ENV", "production")
config = UniversalConfig.from_yaml(
    "config/base.yaml",
    env_file=f"config/{env}.yaml"
)
```

---

### 3. Base YAML

**Purpose:** Common settings across all environments

**File:** `config/base.yaml`

**Format:**
```yaml
# config/base.yaml
system:
  name: vibe-agency
  version: "1.0.0"

database:
  pool_size: 5
  max_overflow: 10

api:
  host: "0.0.0.0"
  port: 8000

logging:
  format: json
  include_timestamp: true
```

**Characteristics:**
- Contains all required configuration keys
- Environment-specific files only need to override what changes
- Should be valid configuration on its own (production defaults)

---

### 4. State Files (JSON)

**Purpose:** Dynamic state managed by the system

**Files:**
- `workspaces/{project}/project_manifest.json` - Project state
- `.session_handoff.json` - Session context
- `.vibe/system_integrity_manifest.json` - System health

**Loading:**
```python
import json

# Loaded separately from config
with open("workspaces/proj_123/project_manifest.json") as f:
    manifest = json.load(f)

# Accessed via VibeConfig API
config = VibeConfig()
manifest = config.get_project_manifest("proj_123")
```

**Note:** State files are NOT merged with YAML config. They are accessed via dedicated APIs.

---

### 5. Defaults (Hardcoded)

**Purpose:** Fallback values when no configuration provided

**Location:** `lib/phoenix_config/config_classes.py`

**Example:**
```python
@dataclass
class DatabaseConfig:
    url: str = "sqlite:///app.db"  # Default
    pool_size: int = 5             # Default
    max_overflow: int = 10         # Default
```

**Characteristics:**
- Only used if key is missing from all other sources
- Should be safe defaults (e.g., localhost, dev database)
- Production should override all critical defaults

---

## Loading Strategy

### Merge Behavior

**1. Deep Merge (Nested Objects)**
```yaml
# base.yaml
database:
  url: sqlite:///app.db
  pool_size: 5
  echo: false

# dev.yaml
database:
  echo: true  # Only override echo, keep url and pool_size from base

# Result:
database:
  url: sqlite:///app.db      # from base
  pool_size: 5               # from base
  echo: true                 # from dev (overridden)
```

**2. Override (Primitive Values)**
```yaml
# base.yaml
logging:
  level: INFO

# dev.yaml
logging:
  level: DEBUG  # Completely replaces INFO

# Result:
logging:
  level: DEBUG
```

**3. Array Override (Lists)**
```yaml
# base.yaml
allowed_hosts:
  - localhost

# prod.yaml
allowed_hosts:
  - example.com
  - www.example.com

# Result: (REPLACES, not appends)
allowed_hosts:
  - example.com
  - www.example.com
```

---

## Environment Detection

### Auto-Detection Logic

```python
def detect_environment() -> str:
    """
    Auto-detect environment from multiple signals.

    Priority:
    1. VIBE_ENV environment variable
    2. Git branch name (claude/* = development)
    3. Presence of .dev file (development)
    4. CI environment variables (testing)
    5. Default to production (safest)
    """

    # 1. Explicit env var
    if "VIBE_ENV" in os.environ:
        return os.environ["VIBE_ENV"]

    # 2. Git branch
    try:
        branch = subprocess.check_output(
            ["git", "branch", "--show-current"],
            text=True
        ).strip()
        if branch.startswith("claude/"):
            return "development"
        if branch == "develop":
            return "staging"
        if branch == "main":
            return "production"
    except:
        pass

    # 3. Marker files
    if Path(".dev").exists():
        return "development"
    if Path(".staging").exists():
        return "staging"

    # 4. CI environment
    if "CI" in os.environ:
        return "testing"

    # 5. Default (safest)
    return "production"
```

---

## Configuration File Structure

### Directory Layout

```
config/
├── phoenix_config.yaml    # Source definitions (meta-config)
├── base.yaml              # Base configuration (all envs)
├── dev.yaml               # Development overrides
├── staging.yaml           # Staging overrides
├── prod.yaml              # Production overrides
├── test.yaml              # Testing overrides
└── schemas/               # JSON schemas for validation
    ├── project_manifest.schema.json
    ├── session_handoff.schema.json
    └── system_integrity.schema.json
```

### phoenix_config.yaml (Meta-Config)

**Purpose:** Define where phoenix_config loads data from

```yaml
# config/phoenix_config.yaml

sources:
  # Base configuration (required)
  base:
    type: yaml
    path: config/base.yaml
    required: true

  # Environment-specific (optional)
  environment:
    type: yaml
    path: config/${VIBE_ENV}.yaml
    required: false

  # Environment variables
  env_vars:
    prefix: VIBE_
    override: true

# State file locations
state_files:
  project_manifest:
    pattern: workspaces/*/project_manifest.json
    schema: config/schemas/project_manifest.schema.json

  session_handoff:
    path: .session_handoff.json
    schema: config/schemas/session_handoff.schema.json

  system_integrity:
    path: .vibe/system_integrity_manifest.json
    schema: config/schemas/system_integrity.schema.json
```

---

## Usage Examples

### Example 1: Development Environment

```python
# Automatic detection
config = VibeConfig()  # Detects "development" from git branch

# Or explicit
config = VibeConfig(env="development")

# Loads:
# 1. config/base.yaml
# 2. config/dev.yaml (overrides base)
# 3. Environment variables (override YAML)

print(config.system.debug)      # True (from dev.yaml)
print(config.logging.level)     # "DEBUG" (from dev.yaml)
print(config.database.url)      # "sqlite:///dev.db" (from dev.yaml)
```

### Example 2: Production Environment

```python
config = VibeConfig(env="production")

# Loads:
# 1. config/base.yaml
# 2. config/prod.yaml (overrides base)
# 3. Environment variables (override YAML)

print(config.system.debug)      # False (from prod.yaml)
print(config.logging.level)     # "INFO" (from prod.yaml)
print(config.database.url)      # From env var VIBE_DATABASE_URL
```

### Example 3: Environment Variable Override

```bash
# Terminal
export VIBE_API_PORT=9000
export VIBE_LOG_LEVEL=WARNING
```

```python
config = VibeConfig(env="production")

# YAML says port=8000, but env var overrides
print(config.api.port)       # 9000 (from env var)
print(config.logging.level)  # "WARNING" (from env var)
```

---

## Implementation Timeline

### Phase 1 (✅ COMPLETE)
- phoenix_config vendored (supports multi-source loading)
- Test suite validates loading from YAML + env vars
- Documentation complete

### Phase 3 (TODO)
- Create `config/base.yaml`
- Create `config/dev.yaml`, `config/prod.yaml`
- Create `config/phoenix_config.yaml`
- Implement VibeConfig wrapper with multi-source support
- Test environment detection logic

---

## Testing Strategy

### Test Cases

```python
def test_base_yaml_loads():
    """Test base configuration loads correctly."""
    config = VibeConfig.from_yaml("config/base.yaml")
    assert config.system.name == "vibe-agency"

def test_environment_override():
    """Test environment-specific config overrides base."""
    config = VibeConfig(env="development")
    assert config.system.debug is True  # from dev.yaml

    config = VibeConfig(env="production")
    assert config.system.debug is False  # from prod.yaml

def test_env_var_override():
    """Test environment variables override YAML."""
    os.environ["VIBE_API_PORT"] = "9000"
    config = VibeConfig()
    assert config.api.port == 9000

def test_deep_merge():
    """Test nested config merges correctly."""
    # base.yaml has database.url, database.pool_size
    # dev.yaml has database.echo
    config = VibeConfig(env="development")

    assert config.database.url  # from base
    assert config.database.pool_size  # from base
    assert config.database.echo is True  # from dev

def test_missing_environment_file():
    """Test graceful fallback when env file missing."""
    config = VibeConfig(env="nonexistent")
    # Should fall back to base.yaml only, no error
    assert config.system.name == "vibe-agency"
```

---

## Related Documents

- **GAD-100:** Configuration & Environment Management (parent)
- **GAD-102:** Environment Overlays
- **GAD-103:** Schema Validation & Governance

---

**Document Version:** 1.0
**Status:** Phase 1 Complete
**Next Review:** Phase 3 Implementation
