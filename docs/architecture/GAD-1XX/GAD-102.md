# GAD-102: Environment Overlays

**Status:** Phase 1 Complete (Documentation)
**Parent:** GAD-100 Configuration & Environment Management
**Created:** 2025-11-17
**Last Updated:** 2025-11-17

---

## Overview

GAD-102 defines the environment overlay system for vibe-agency. Environment overlays allow different configuration settings for development, staging, and production while maintaining a common base configuration.

---

## Environment Types

### 1. Development (`dev`)

**Purpose:** Local development and debugging

**Characteristics:**
- Debug mode enabled
- Verbose logging
- Hot reload enabled
- Local file-based database
- Permissive security settings
- Fast feedback loops

**Example: `config/dev.yaml`**
```yaml
system:
  debug: true
  environment: development

database:
  url: sqlite:///dev.db
  echo: true
  auto_create_tables: true

api:
  debug: true
  reload: true
  cors_origins:
    - http://localhost:3000
    - http://127.0.0.1:3000

logging:
  level: DEBUG
  format: console
  colorized: true

security:
  require_https: false
  session_timeout: 86400  # 24 hours

performance:
  enable_caching: false  # Always fresh data for debugging
```

---

### 2. Staging (`staging`)

**Purpose:** Pre-production testing environment

**Characteristics:**
- Production-like settings
- Moderate logging
- Real database (non-production data)
- Security enabled but less strict
- Performance monitoring enabled

**Example: `config/staging.yaml`**
```yaml
system:
  debug: false
  environment: staging

database:
  url: ${STAGING_DATABASE_URL}  # From environment variable
  pool_size: 10
  echo: false

api:
  debug: false
  reload: false
  workers: 2
  cors_origins:
    - https://staging.example.com

logging:
  level: INFO
  format: json
  include_request_id: true

security:
  require_https: true
  session_timeout: 3600  # 1 hour

performance:
  enable_caching: true
  cache_ttl: 300  # 5 minutes
```

---

### 3. Production (`prod`)

**Purpose:** Live production environment

**Characteristics:**
- Maximum security
- Optimized performance
- Minimal logging (INFO/WARNING only)
- Production database
- Error monitoring enabled
- High availability settings

**Example: `config/prod.yaml`**
```yaml
system:
  debug: false
  environment: production

database:
  url: ${PROD_DATABASE_URL}  # From environment variable
  pool_size: 20
  max_overflow: 40
  echo: false
  pool_recycle: 3600

api:
  debug: false
  reload: false
  workers: 4
  timeout: 30
  cors_origins:
    - https://example.com
    - https://www.example.com

logging:
  level: INFO
  format: json
  include_request_id: true
  include_user_id: false  # Privacy

security:
  require_https: true
  session_timeout: 1800  # 30 minutes
  rate_limit_enabled: true
  rate_limit_requests: 100
  rate_limit_window: 60

performance:
  enable_caching: true
  cache_ttl: 3600  # 1 hour
  compression_enabled: true
```

---

### 4. Testing (`test`)

**Purpose:** Automated test execution

**Characteristics:**
- Fast execution
- In-memory database
- Minimal logging
- Isolated from other environments
- Deterministic behavior

**Example: `config/test.yaml`**
```yaml
system:
  debug: false
  environment: testing

database:
  url: sqlite:///:memory:  # In-memory for speed
  echo: false
  auto_create_tables: true

api:
  port: 0  # Random available port
  debug: false
  reload: false

logging:
  level: ERROR  # Only show errors in tests
  format: console

security:
  require_https: false
  skip_authentication: true  # For test convenience

performance:
  enable_caching: false  # Tests should be deterministic

testing:
  mock_external_apis: true
  fast_mode: true
```

---

## Base Configuration Strategy

### What Belongs in base.yaml

**Rule of Thumb:** Base configuration should contain:
1. **Required keys** (all environments need these)
2. **Safe defaults** (production-safe values)
3. **Common settings** (same across all environments)

**Example: `config/base.yaml`**
```yaml
# config/base.yaml
system:
  name: vibe-agency
  version: "1.0.0"

database:
  pool_size: 5
  max_overflow: 10
  pool_timeout: 30
  pool_recycle: 3600
  auto_create_tables: false  # Safe default (don't auto-modify prod)

api:
  host: "0.0.0.0"
  port: 8000
  timeout: 60
  max_request_size: 10485760  # 10 MB

logging:
  format: json
  include_timestamp: true
  include_level: true

security:
  require_https: true  # Safe default (most restrictive)
  session_timeout: 1800

performance:
  enable_caching: true
  cache_ttl: 3600
```

---

## Overlay Merge Rules

### Rule 1: Deep Merge for Objects

Environment overlays **merge** with base, not replace:

```yaml
# base.yaml
database:
  pool_size: 5
  max_overflow: 10
  echo: false

# dev.yaml
database:
  echo: true  # Only override this key

# Result (dev environment):
database:
  pool_size: 5        # from base
  max_overflow: 10    # from base
  echo: true          # from dev
```

### Rule 2: Complete Override for Lists

Arrays are **replaced**, not merged:

```yaml
# base.yaml
api:
  cors_origins:
    - https://example.com

# dev.yaml
api:
  cors_origins:
    - http://localhost:3000

# Result (dev environment):
api:
  cors_origins:
    - http://localhost:3000  # Completely replaces base list
```

### Rule 3: Environment Variables Win

Environment variables have highest priority:

```yaml
# prod.yaml
database:
  url: postgresql://prod.example.com/db
```

```bash
# Environment variable
export VIBE_DATABASE_URL=postgresql://backup.example.com/db
```

```python
# Result:
config.database.url == "postgresql://backup.example.com/db"  # Env var wins
```

---

## Environment Detection

### Automatic Detection

```python
def detect_environment() -> str:
    """
    Auto-detect environment from multiple signals.

    Detection order:
    1. VIBE_ENV environment variable (explicit)
    2. Git branch name (implicit)
    3. Marker files (.dev, .staging)
    4. CI environment (implicit)
    5. Default to production (safest)
    """

    # 1. Explicit environment variable
    if "VIBE_ENV" in os.environ:
        env = os.environ["VIBE_ENV"].lower()
        if env in ["development", "dev"]:
            return "development"
        if env in ["staging", "stage"]:
            return "staging"
        if env in ["production", "prod"]:
            return "production"
        if env in ["testing", "test"]:
            return "testing"

    # 2. Git branch detection
    try:
        result = subprocess.run(
            ["git", "branch", "--show-current"],
            capture_output=True,
            text=True,
            check=True
        )
        branch = result.stdout.strip()

        if branch.startswith("claude/"):
            return "development"
        if branch == "develop":
            return "staging"
        if branch == "main" or branch == "master":
            return "production"
    except:
        pass

    # 3. Marker files
    if Path(".dev").exists():
        return "development"
    if Path(".staging").exists():
        return "staging"
    if Path(".production").exists():
        return "production"

    # 4. CI environment
    if any(k in os.environ for k in ["CI", "GITHUB_ACTIONS", "GITLAB_CI"]):
        return "testing"

    # 5. Safe default
    return "production"
```

### Manual Override

```python
# Force specific environment
config = VibeConfig(env="development")

# Or via environment variable
os.environ["VIBE_ENV"] = "staging"
config = VibeConfig()  # Auto-detects staging
```

---

## Environment-Specific Behavior

### Example: Logging Configuration

```python
from agency_os.config import VibeConfig

config = VibeConfig()

if config.environment == "development":
    # Development: Colorized console output
    import logging
    logging.basicConfig(
        level=logging.DEBUG,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )

elif config.environment == "production":
    # Production: JSON structured logging
    import json_logging
    json_logging.init_non_web(enable_json=True)
    logging.basicConfig(level=logging.INFO)
```

### Example: Error Handling

```python
def handle_error(error: Exception):
    config = VibeConfig()

    if config.environment == "development":
        # Development: Show full stack trace
        import traceback
        print(traceback.format_exc())
        return {"error": str(error), "trace": traceback.format_exc()}

    elif config.environment == "production":
        # Production: Generic error message, log details
        logger.error(f"Error: {error}", exc_info=True)
        return {"error": "An error occurred. Please contact support."}
```

### Example: Database Connections

```python
from agency_os.config import VibeConfig

config = VibeConfig()

if config.environment == "testing":
    # Testing: In-memory SQLite (fast, isolated)
    engine = create_engine("sqlite:///:memory:")

elif config.environment == "development":
    # Development: Local file-based SQLite
    engine = create_engine("sqlite:///dev.db", echo=True)

elif config.environment == "production":
    # Production: PostgreSQL with connection pooling
    engine = create_engine(
        config.database.url,
        pool_size=config.database.pool_size,
        max_overflow=config.database.max_overflow
    )
```

---

## Environment Validation

### Validation Rules

**Development:**
- ✅ Debug mode allowed
- ✅ Local databases allowed
- ✅ Insecure connections allowed
- ⚠️ Warn if production database URL detected

**Staging:**
- ⚠️ Debug mode allowed but warned
- ✅ Test databases allowed
- ✅ HTTPS required (but not enforced)
- ❌ Production database URL forbidden

**Production:**
- ❌ Debug mode forbidden
- ❌ Local databases forbidden
- ✅ HTTPS required (enforced)
- ✅ Production database URL required
- ❌ Development tools (hot reload, etc.) forbidden

### Validation Implementation

```python
def validate_environment_config(config: VibeConfig):
    """Validate configuration for current environment."""
    errors = []
    warnings = []

    if config.environment == "production":
        # Production validations (strict)
        if config.system.debug:
            errors.append("Debug mode forbidden in production")

        if "sqlite" in config.database.url:
            errors.append("SQLite forbidden in production")

        if not config.security.require_https:
            errors.append("HTTPS required in production")

        if config.api.reload:
            errors.append("Hot reload forbidden in production")

    elif config.environment == "development":
        # Development warnings (informational)
        if "postgresql" in config.database.url.lower():
            warnings.append("Using PostgreSQL in dev (consider SQLite for speed)")

    if errors:
        raise ConfigurationError(
            f"Invalid {config.environment} configuration",
            validation_errors=errors
        )

    if warnings:
        for warning in warnings:
            logger.warning(f"Configuration warning: {warning}")
```

---

## Implementation Timeline

### Phase 1 (✅ COMPLETE)
- Documentation complete
- phoenix_config supports environment overlays

### Phase 3 (TODO)
- Create all environment YAML files
- Implement environment detection logic
- Implement validation rules
- Test environment switching

---

## Testing Strategy

```python
def test_development_environment():
    """Test development-specific configuration."""
    config = VibeConfig(env="development")

    assert config.system.debug is True
    assert config.logging.level == "DEBUG"
    assert "sqlite" in config.database.url

def test_production_environment():
    """Test production-specific configuration."""
    config = VibeConfig(env="production")

    assert config.system.debug is False
    assert config.logging.level == "INFO"
    assert config.security.require_https is True

def test_environment_override():
    """Test environment file overrides base."""
    base = VibeConfig.from_yaml("config/base.yaml")
    dev = VibeConfig(env="development")

    # Debug should differ
    assert base.system.debug != dev.system.debug

    # Name should be same (from base)
    assert base.system.name == dev.system.name

def test_production_validation_catches_debug():
    """Test production rejects debug mode."""
    with pytest.raises(ConfigurationError):
        config = VibeConfig(env="production")
        config.system.debug = True
        validate_environment_config(config)
```

---

## Best Practices

### DO:
- ✅ Keep base.yaml production-safe
- ✅ Use environment variables for secrets
- ✅ Validate config at startup
- ✅ Document environment-specific behavior
- ✅ Test all environments in CI

### DON'T:
- ❌ Put secrets in YAML files
- ❌ Use development settings in production
- ❌ Skip validation
- ❌ Make base.yaml development-specific
- ❌ Assume environment without detection

---

## Related Documents

- **GAD-100:** Configuration & Environment Management (parent)
- **GAD-101:** Multi-Source Configuration Loading
- **GAD-103:** Schema Validation & Governance

---

**Document Version:** 1.0
**Status:** Phase 1 Complete
**Next Review:** Phase 3 Implementation
