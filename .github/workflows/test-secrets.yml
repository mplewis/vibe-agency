name: Test GitHub Secrets

on:
  push:
    branches: [ claude/create-gad-003-* ]
  workflow_dispatch:

jobs:
  test-secrets:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test API Key Secret Access
        env:
          GOOGLE_SEARCH_API_KEY: ${{ secrets.GOOGLE_SEARCH_API_KEY }}
          GOOGLE_SEARCH_ENGINE_ID: ${{ secrets.GOOGLE_SEARCH_ENGINE_ID }}
        run: |
          echo "=== Testing GitHub Secrets Access ==="

          # Check if secrets are loaded
          if [ -z "$GOOGLE_SEARCH_API_KEY" ]; then
            echo "‚ùå ERROR: GOOGLE_SEARCH_API_KEY is not set!"
            exit 1
          fi

          if [ -z "$GOOGLE_SEARCH_ENGINE_ID" ]; then
            echo "‚ùå ERROR: GOOGLE_SEARCH_ENGINE_ID is not set!"
            exit 1
          fi

          # Show secret lengths (without revealing values)
          echo "‚úÖ GOOGLE_SEARCH_API_KEY is set (length: ${#GOOGLE_SEARCH_API_KEY} chars)"
          echo "‚úÖ GOOGLE_SEARCH_ENGINE_ID is set (value: $GOOGLE_SEARCH_ENGINE_ID)"

          echo ""
          echo "=== Secrets loaded successfully! ==="

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4

      - name: Test Google Search API
        env:
          GOOGLE_SEARCH_API_KEY: ${{ secrets.GOOGLE_SEARCH_API_KEY }}
          GOOGLE_SEARCH_ENGINE_ID: ${{ secrets.GOOGLE_SEARCH_ENGINE_ID }}
        continue-on-error: true
        id: google-search-test
        run: |
          echo "=== Testing Google Custom Search API ==="
          python agency_os/00_system/orchestrator/tools/google_search_client.py && {
            echo "‚úÖ Google Search API test passed!"
            exit 0
          } || {
            echo ""
            echo "‚ùå Google Search API test failed!"
            echo ""
            echo "üìã SETUP REQUIRED:"
            echo "The Google Custom Search API needs to be configured."
            echo ""
            echo "Please follow this guide:"
            echo "üëâ https://github.com/kimeisele/vibe-agency/blob/main/docs/setup/GOOGLE_SEARCH_SETUP.md"
            echo ""
            echo "Quick checklist:"
            echo "  1. Create Custom Search Engine at https://programmablesearchengine.google.com"
            echo "  2. Enable Custom Search API in Google Cloud Console"
            echo "  3. Create API key"
            echo "  4. Update GitHub Secrets with correct IDs"
            echo "  5. Ensure billing is enabled (required even for free tier)"
            echo ""
            exit 1
          }

      - name: Report Google Search API Status
        if: steps.google-search-test.outcome == 'failure'
        run: |
          echo "‚ö†Ô∏è  Google Search API is not yet configured."
          echo "This is OPTIONAL for Phase 1. You can configure it later."
          echo "See docs/setup/GOOGLE_SEARCH_SETUP.md for instructions."

      - name: Test Web Fetch Client
        run: |
          echo "=== Testing Web Fetch Client ==="
          python agency_os/00_system/orchestrator/tools/web_fetch_client.py || {
            echo "‚ùå Web Fetch Client test failed!"
            exit 1
          }
          echo "‚úÖ Web Fetch Client test passed!"
