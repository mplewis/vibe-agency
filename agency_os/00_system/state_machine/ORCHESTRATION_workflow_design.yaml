# =================================================================
# ORCHESTRATION_workflow_design.yaml
# Defines die SDLC-statesmaschine, ihre Zustände, Übergänge
# und Fehlerbehandlungs-Schleifen.
# Based auf der Analyse in Teil 1 dieses Berichts.
# =================================================================
version: 1.0.0
kind: SDLCStateMachine

# 1. Definition der Workflow-Zustände (States)
# Jeder state entspricht einem Kern-Framework.
states:
 - name: "PLANNING"
   description: "Impliziter Startzustand. Anforderungen werden in ein project_manifest umgewandelt."
   responsible_framework: "ProjectManagement"
   output_artifact: "project_manifest.json"
   
 - name: "CODING"
   description: "Gesteuert durch das Code-Gen-Framework. Nimmt code_gen_spec entgegen und erzeugt artifact_bundle."
   responsible_framework: "CODE_GEN "
   input_artifact: "code_gen_spec.json"
   output_artifact: "artifact_bundle"

 - name: "TESTING"
   description: "Gesteuert durch das QA-Framework. Führt die Testpyramide aus und erzeugt einen QA-Bericht."
   responsible_framework: "QA_TESTING "
   input_artifact: ["artifact_bundle", "test_plan.json"]
   output_artifact: "qa_report.json"

 - name: "AWAITING_QA_APPROVAL"
   description: "Ein langlebiger (durable) Wartezustand, der auf eine manuelle HITL-Genehmigung wartet."
   responsible_framework: "Orchestrator (HITL)"
   input_artifact: "qa_report.json"
   
 - name: "DEPLOYMENT"
   description: "Gesteuert durch das Deployment-Framework. Führt das Deployment in die Produktion durch."
   responsible_framework: "DEPLOYMENT "
   input_artifact: "qa_report.json" # (Mit Status APPROVED)
   output_artifact: "deploy_receipt.json"

 - name: "PRODUCTION"
   description: "Endzustand. Der Workflow ist erfolgreich abgeschlossen."
   responsible_framework: "N/A (Terminal State)"

 - name: "MAINTENANCE"
   description: "Paralleler, ereignisgesteuerter state, gesteuert durch. Löst Fix-Workflows aus."
   responsible_framework: "MAINTENANCE "
   input_artifact: "bug_report.json"
   output_artifact: "code_gen_spec.json" # (Für den Fix)

 - name: "EXTERNAL_EVENT"
   description: "Ein Pseudo-state, der einen externen, ereignisgesteuerten Startpunkt für einen Workflow darstellt, z.B. einen eingehenden Bug-Report."
   responsible_framework: "Orchestrator (Event Listener)"

# 2. Definition der Workflow-Übergänge (Transitions)
transitions:
 - name: "T1_StartCoding"
   from_state: "PLANNING"
   to_state: "CODING"
   trigger: "project_manifest.json erstellt mit gültigem code_gen_spec link."
   type: "Automated"

 - name: "T2_StartTesting"
   from_state: "CODING"
   to_state: "TESTING"
   trigger: "artifact_bundle erstellt UND interne Code-Gen Quality Gates  bestanden."
   type: "Automated"

 - name: "T3_RequestQAApproval"
   from_state: "TESTING"
   to_state: "AWAITING_QA_APPROVAL"
   trigger: "qa_report.json erstellt (unabhängig vom Status)."
   type: "Automated"
   
 - name: "T4_StartDeployment"
   from_state: "AWAITING_QA_APPROVAL"
   to_state: "DEPLOYMENT"
   trigger: "HITL-Ereignis: 'qa_approved_signal' empfangen UND qa_report.status == 'APPROVED'."
   type: "Human-in-the-Loop (HITL)"

 - name: "T5_DeploymentSuccess"
   from_state: "DEPLOYMENT"
   to_state: "PRODUCTION"
   trigger: "deploy_receipt.json erstellt mit status == 'SUCCESS'."
   type: "Automated"

 - name: "T6_TriggerMaintenance"
   from_state: "EXTERNAL_EVENT"
   to_state: "MAINTENANCE"
   trigger: "Asynchrones Signal 'bug_report_received' mit gültigem bug_report.json."
   type: "Event-Driven"

# 3. Definition der Fehler- und Rückkopplungsschleifen (Loops)
loops:
 - name: "L1_TestFailed"
   description: "Test-Phase fehlgeschlagen, erfordert Code-Fix."
   from_state: "AWAITING_QA_APPROVAL"
   to_state: "CODING"
   trigger: "HITL-Ereignis: 'qa_rejected_signal' empfangen ODER qa_report.status == 'REJECTED'."
   action: "Übergebe qa_report.json als Feedback-Paket an den CODING-state."

 - name: "L2_DeployFailed"
   description: "Deployment fehlgeschlagen und zurückgerollt, erfordert P1-Bugfix."
   from_state: "DEPLOYMENT"
   to_state: "MAINTENANCE"
   trigger: "deploy_receipt.json erstellt mit status == 'ROLLED_BACK'."
   action: "Automatische Erstellung eines P1_Critical bug_report.json aus dem deploy_receipt und Auslösung von T6."

 - name: "L3_HotfixLoop"
   description: "Ein P1-Bug umgeht das reguläre Planning."
   from_state: "MAINTENANCE"
   to_state: "CODING"
   trigger: "Bug-Triage  klassifiziert als 'Hotfix'."
   action: "Neue Workflow-Instanz mit hoher Priorität starten."

 - name: "L4_RegularFixLoop"
   description: "Ein P2-P5-Bug muss im Backlog priorisiert werden."
   from_state: "MAINTENANCE"
   to_state: "PLANNING"
   trigger: "Bug-Triage  klassifiziert als 'Regular Fix'."
   action: "Item zum PLANNING-Backlog hinzufügen."