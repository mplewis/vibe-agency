# =================================================================
# ORCHESTRATION_data_contracts.yaml
# Defines JSON schemas for all artifacts passed between
# workflow states.
# Based on the analysis in Part 2 of this report.
# =================================================================
version: 1.0.0
kind: SchemaCollection

# 1. Governance rules for schema evolution
# Based on [4, 10, 11, 12]
schema_evolution_rules:
 - type: "ADD_OPTIONAL_FIELD"
   compatibility: "BACKWARD_COMPATIBLE"
   version_bump: "MINOR"
   allowed: true
 - type: "ADD_FIELD_WITH_DEFAULT"
   compatibility: "BACKWARD_COMPATIBLE"
   version_bump: "MINOR"
   allowed: true
 - type: "ADD_REQUIRED_FIELD"
   compatibility: "BREAKING_CHANGE"
   version_bump: "MAJOR"
   allowed: false # (Must be avoided for v1.0)
 - type: "REMOVE_FIELD"
   compatibility: "BREAKING_CHANGE"
   version_bump: "MAJOR"
   allowed: false # (Must be avoided for v1.0)
 - type: "RENAME_FIELD"
   compatibility: "BREAKING_CHANGE"
   version_bump: "MAJOR"
   allowed: false # (Use "Expand/Contract" pattern)
 - type: "CHANGE_FIELD_TYPE"
   compatibility: "BREAKING_CHANGE"
   version_bump: "MAJOR"
   allowed: false

# 2. Schema definitions (excerpts of most important fields)
schemas:

 - name: "project_manifest.schema.json"
   version: "1.1.0"
   $id: "https://api.example.com/schemas/project_manifest.v1.1.0.json"
   description: "The central contract containing workflow state and artifact links."
   fields:
     - name: "schema_version"
       type: "string"
       required: true
     - name: "project_id"
       type: "string(uuid)"
       required: true
     - name: "project_type"
       type: "enum"
       required: false
       default: "commercial"
       values: ["commercial", "portfolio", "demo", "nonprofit", "personal"]
       description: "Project context type - determines workflow intensity (full vs quick mode)"
     - name: "current_state"
       type: "enum"
       required: true
       values:
     - name: "links"
       type: "object"
       required: true
       properties:
         - { name: "code_gen_spec", type: "string(uri)" }
         - { name: "test_plan", type: "string(uri)" }
         - { name: "qa_report", type: "string(uri)" }
         - { name: "deploy_receipt", type: "string(uri)" }

 - name: "feature_spec.schema.json"
   version: "1.0.0"
   $id: "https://api.example.com/schemas/feature_spec.v1.0.0.json"
   description: "Output of the PLANNING state. Defines validated feature specifications."
   fields:
     - name: "project"
       type: "object"
       required: true
       properties:
         - { name: "name", type: "string", description: "Project Name" }
         - { name: "category", type: "enum", values: ["CLI Tool", "Web App", "Mobile App", "API Service"], description: "Project Category" }
         - { name: "scale", type: "enum", values: ["Solo User", "Small Team", "Production"], description: "Project Scale" }
         - { name: "target_scope", type: "enum", values: ["prototype", "mvp", "v1.0"], description: "Target Scope" }
         - { name: "core_problem", type: "string", description: "1-2 sentence description of what problem this solves" }
         - { name: "target_users", type: "string", description: "Who will use this" }
     - name: "lean_canvas_summary"
       type: "object"
       required: false # Optional, as LEAN_CANVAS_VALIDATOR might be optional
       properties:
         - { name: "riskiest_assumptions", type: "array", items: "string", description: "Identified riskiest assumptions from Lean Canvas" }
     - name: "features"
       type: "array"
       required: true
       items:
         type: "object"
         properties:
           - { name: "id", type: "string" }
           - { name: "name", type: "string" }
           - { name: "priority", type: "enum", values: ["must_have", "should_have", "could_have", "wont_have_v1"] }
           - { name: "complexity_score", type: "integer" }
           - { name: "estimated_effort", type: "string" }
           - name: "input"
             type: "object"
             properties:
               - { name: "format", type: "string" }
               - { name: "example", type: "string" }
               - { name: "constraints", type: "string" }
           - name: "processing"
             type: "object"
             properties:
               - { name: "description", type: "string" }
               - { name: "external_dependencies", type: "array", items: "string" }
               - { name: "side_effects", type: "array", items: "string" }
           - name: "output"
             type: "object"
             properties:
               - { name: "format", type: "string" }
               - { name: "example", type: "string" }
               - { name: "success_criteria", type: "string" }
           - name: "dependencies"
             type: "object"
             properties:
               - name: "required"
                 type: "array"
                 items:
                   type: "object"
                   properties:
                     - { name: "component", type: "string" }
                     - { name: "reason", type: "string" }
                     - { name: "source", type: "string" }
               - { name: "optional", type: "array", items: "string" }
           - name: "fae_validation"
             type: "object"
             properties:
               - { name: "passed", type: "boolean" }
               - { name: "constraints_checked", type: "array", items: "string" }
               - { name: "issues", type: "array", items: "string" }
     - name: "nfr_requirements"
       type: "array"
       required: false # Optional, as NFR Triage might be skipped or not fully filled
       items:
         type: "object"
         properties:
           - { name: "nfr_id", type: "string" }
           - { name: "category", type: "string" }
           - { name: "target_level", type: "string" }
           - { name: "reason", type: "string" }
     - name: "scope_negotiation"
       type: "object"
       required: true
       properties:
         - { name: "total_complexity", type: "integer" }
         - name: "complexity_breakdown"
           type: "object"
           properties:
             - { name: "must_have", type: "integer" }
             - { name: "should_have", type: "integer" }
             - { name: "wont_have_v1", type: "integer" }
         - { name: "timeline_estimate", type: "string" }
         - { name: "v1_exclusions", type: "array", items: "string" }
     - name: "validation"
       type: "object"
       required: true
       properties:
         - { name: "fae_passed", type: "boolean" }
         - { name: "fdg_passed", type: "boolean" }
         - { name: "apce_passed", type: "boolean" }
         - { name: "all_features_complete", type: "boolean" }
         - { name: "ready_for_genesis", type: "boolean" }
     - name: "metadata"
       type: "object"
       required: true
       properties:
         - { name: "vibe_version", type: "string" }
         - { name: "created_at", type: "string" }
         - { name: "user_educated", type: "boolean" }
         - { name: "scope_negotiated", type: "boolean" }

 - name: "code_gen_spec.schema.json"
   version: "1.0.0"
   $id: "https://api.example.com/schemas/code_gen_spec.v1.0.0.json"
   description: "Input for the CODING state. Defines the L1-L4 context for the AI."
   fields:
     - name: "schema_version"
       type: "string"
       required: true
     - name: "structured_specification" # L1
       type: "object"
       required: true
       properties:
         - { name: "architecture_ref", type: "string(uri)" }
     - name: "database_context" # L2
       type: "object"
       required: true
       properties:
         - { name: "db_schema_ref", type: "string(uri)" }
     - name: "task_context" # L3
       type: "object"
       required: true
       properties:
         - { name: "intent", type: "string" }
         - { name: "scope", type: "object" }
         - { name: "acceptance_criteria", type: "array" }
     - name: "system_context" # L4
       type: "object"
       required: true
       properties:
         - { name: "knowledge_graph_query", type: "string" }

 - name: "test_plan.schema.json"
   version: "1.0.0"
   $id: "https://api.example.com/schemas/test_plan.v1.0.0.json"
   description: "Input for the TESTING state. Defines the test scope."
   fields:
     - name: "schema_version"
       type: "string"
       required: true
     - name: "test_pyramid_config"
       type: "object"
       required: true
       properties:
         - { name: "unit_tests", type: "object" }
         - { name: "integration_tests", type: "object" }
         - { name: "e2e_tests", type: "object" }
     - name: "deferred_tests_v1"
       type: "array"
       required: true
       items: "string" # z.B. "Load", "Penetration" 
     - name: "hitl_requirements"
       type: "object"
       required: true
       properties:
         - { name: "usability_acceptance_criteria", type: "string" }

 - name: "qa_report.schema.json"
   version: "1.0.0"
   $id: "https://api.example.com/schemas/qa_report.v1.0.0.json"
   description: "Output des TESTING-Zustands. Dient als "Exit-Gate" für die HITL-Genehmigung."
   fields:
     - name: "schema_version"
       type: "string"
       required: true
     - name: "status"
       type: "enum"
       required: true
       values: ["PASSED", "FAILED", "PARTIAL"]
     - name: "critical_path_pass_rate"
       type: "number"
       required: true
     - name: "blocker_bugs_open"
       type: "integer"
       required: true
     - name: "coverage_on_new_code"
       type: "number"
       required: true
     - name: "manual_ux_review_completed"
       type: "boolean"
       required: true
     - name: "sast_check_passed"
       type: "boolean"
       required: true
     - name: "sca_check_passed"
       type: "boolean"
       required: true

 - name: "deploy_receipt.schema.json"
   version: "1.0.0"
   $id: "https://api.example.com/schemas/deploy_receipt.v1.0.0.json"
   description: "Output des DEPLOYMENT-Zustands. Dient als "Beweis" des Deployments."
   fields:
     - name: "schema_version"
       type: "string"
       required: true
     - name: "status"
       type: "enum"
       required: true
       values: ["SUCCESS", "ROLLED_BACK", "IN_PROGRESS"]
     - name: "artifact_version_deployed"
       type: "string"
       required: true
     - name: "db_migration_status"
       type: "enum"
       required: true
       values: ["APPLIED", "SKIPPED", "FAILED"]
     - name: "health_check_status"
       type: "enum"
       required: true
       values: ["OK", "DEGRADED", "FAILED"]
     - name: "golden_signal_values" # Gemessen während "Soak Time" 
       type: "object"
       required: true
       properties:
         - { name: "latency_p95_ms", type: "integer" }
         - { name: "error_rate_percent", type: "number" }

 - name: "bug_report.schema.json"
   version: "1.0.0"
   $id: "https://api.example.com/schemas/bug_report.v1.0.0.json"
   description: "Input für den MAINTENANCE-Zustand. Löst den Triage-Workflow aus."
   fields:
     - name: "schema_version"
       type: "string"
       required: true
     - name: "severity"
       type: "enum"
       required: true
       values: ["P1_Critical", "P2_High", "P3_Medium", "P4_Low", "P5_Cosmetic"]
     - name: "category"
       type: "enum"
       required: true
       values: ["Security", "Performance", "Functional", "UI", "Data"]
     - name: "context"
       type: "object"
       required: true
       properties:
         - { name: "PII_impact", type: "boolean", default: false }
     - name: "reproducible"
       type: "boolean"
       required: true
     - name: "correlated_trace_id"
       type: "string" # Kritisch für Observability 
       required: false