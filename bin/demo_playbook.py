#!/usr/bin/env python3
"""
ARCH-013 & ARCH-014: Playbook Demo & Golden Thread Verification
================================================================

This script demonstrates the "Cartridge Slot" functionality:
1. Loads a playbook YAML
2. Validates it
3. Executes it using the PlaybookRunner
4. Outputs results to a file
5. For feature-implement, can dogfood by generating actual tools

Proof of concept: Shows that the system can load dynamic workflow presets
and execute them without hardcoded phases. ARCH-014 extends this to show
real tool generation (vibe-standup.py).

Usage:
    python bin/demo_playbook.py [playbook_id_or_path] [--goal "mission description"]

Examples:
    python bin/demo_playbook.py hello-world
    python bin/demo_playbook.py feature-implement
    python bin/demo_playbook.py feature-implement --goal "Create bin/vibe-standup.py..."
    python bin/demo_playbook.py playbooks/presets/custom.yaml
"""

import json
import logging
import sys
from pathlib import Path

# Add project root to path for imports BEFORE importing vibe_core modules
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from vibe_core.playbook.runner import (  # noqa: E402
    PlaybookError,
    PlaybookRunner,
)

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
)

logger = logging.getLogger(__name__)


def generate_vibe_standup(goal: str):
    """
    ARCH-014: Dogfooding - Generate vibe-standup.py from mission description.

    This demonstrates that the Playbook Engine can autonomously generate
    useful tools (proof that the cartridge slot works end-to-end).
    """
    standup_code = '''#!/usr/bin/env python3
"""
bin/vibe-standup: Daily Standup Analysis Tool
==============================================

Autonomous tool generated by VIBE Agency Playbook Engine (ARCH-014).
Generated by: feature-implement playbook with vibe-standup mission.

This tool performs a 'Daily Standup' analysis:
1. Scan git log for last 24 hours
2. Summarize files changed
3. Print a motivation quote
4. Save report to daily_update.md
"""

import subprocess
import json
import sys
from pathlib import Path
from datetime import datetime, timedelta
import random

# Motivation quotes for standups
MOTIVATION_QUOTES = [
    "Code is poetry written for machines. Make it beautiful.",
    "Every bug fixed is a victory. Every test passed is progress.",
    "Refactoring today prevents firefighting tomorrow.",
    "Clean code is written so that another person can understand it. Be that person.",
    "The best code is the code that doesn't need to be debugged.",
    "Don't just write code. Write stories that computers understand.",
    "Today's debugging is tomorrow's story.",
]


def get_git_log_24h():
    """Get git log entries from the last 24 hours."""
    try:
        since = (datetime.now() - timedelta(hours=24)).isoformat()
        result = subprocess.run(
            ["git", "log", f"--since={since}", "--oneline"],
            capture_output=True,
            text=True,
            check=False,
        )
        if result.returncode == 0:
            return result.stdout.strip().split("\\n") if result.stdout.strip() else []
        return []
    except Exception as e:
        print(f"‚ö†Ô∏è  Error reading git log: {e}")
        return []


def get_files_changed_24h():
    """Get list of files changed in the last 24 hours."""
    try:
        since = (datetime.now() - timedelta(hours=24)).isoformat()
        result = subprocess.run(
            ["git", "diff", "--name-only", f"--since={since}"],
            capture_output=True,
            text=True,
            check=False,
        )
        if result.returncode == 0:
            files = result.stdout.strip().split("\\n") if result.stdout.strip() else []
            return [f for f in files if f]  # Remove empty strings
        return []
    except Exception as e:
        print(f"‚ö†Ô∏è  Error reading changed files: {e}")
        return []


def get_motivation_quote():
    """Return a random motivation quote."""
    return random.choice(MOTIVATION_QUOTES)


def save_report(report_content: str):
    """Save standup report to daily_update.md."""
    output_file = Path("daily_update.md")
    try:
        with open(output_file, "w") as f:
            f.write(report_content)
        print(f"‚úÖ Report saved to: {output_file}")
        return True
    except Exception as e:
        print(f"‚ùå Error saving report: {e}")
        return False


def main():
    """Main standup analysis function."""
    print("=" * 70)
    print("üöÄ VIBE Agency - Daily Standup Analysis")
    print("=" * 70)

    # Get data
    commits = get_git_log_24h()
    files_changed = get_files_changed_24h()
    quote = get_motivation_quote()

    # Build report
    report = []
    report.append("# Daily Standup Report\\n")
    report.append(f"**Generated:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\\n")
    report.append(f"**Reporting Period:** Last 24 hours\\n\\n")

    # Section: Git Activity
    report.append("## üìä Git Activity (Last 24 Hours)\\n")
    if commits:
        report.append(f"**Total Commits:** {len(commits)}\\n\\n")
        report.append("**Recent Commits:**\\n")
        for commit in commits[:10]:  # Show last 10
            report.append(f"- {commit}\\n")
        if len(commits) > 10:
            report.append(f"\\n... and {len(commits) - 10} more commits\\n")
    else:
        report.append("No commits in the last 24 hours.\\n")

    report.append("\\n")

    # Section: Files Changed
    report.append("## üìù Files Changed\\n")
    if files_changed:
        report.append(f"**Total Files Modified:** {len(files_changed)}\\n\\n")
        report.append("**Files:**\\n")
        for file in sorted(files_changed)[:20]:  # Show first 20
            report.append(f"- `{file}`\\n")
        if len(files_changed) > 20:
            report.append(f"\\n... and {len(files_changed) - 20} more files\\n")
    else:
        report.append("No files changed in the last 24 hours.\\n")

    report.append("\\n")

    # Section: Motivation
    report.append("## üí° Daily Thought\\n")
    report.append(f"> {quote}\\n\\n")

    # Section: Summary
    report.append("---\\n")
    report.append("\\n**Tool:** Autonomously generated by VIBE Agency Playbook Engine\\n")
    report.append("**Architecture:** ARCH-014 Golden Thread Verification\\n")

    report_content = "".join(report)

    # Print to console
    print("\\n" + report_content)

    # Save to file
    if save_report(report_content):
        print("\\n" + "=" * 70)
        print("‚úÖ Daily standup analysis complete!")
        print("=" * 70)
        return 0
    else:
        return 1


if __name__ == "__main__":
    sys.exit(main())
'''
    return standup_code


def main():
    """Main demo function"""

    # Parse arguments
    playbook_id = "hello-world"  # Default
    goal = None

    if len(sys.argv) >= 2:
        playbook_id = sys.argv[1]

        # Check for --goal parameter
        if len(sys.argv) >= 4 and sys.argv[2] == "--goal":
            goal = sys.argv[3]

    if playbook_id == "hello-world":
        logger.info(f"No playbook specified, using default: {playbook_id}")

    # Create output directory
    output_dir = project_root / ".demo_output"
    output_dir.mkdir(exist_ok=True)

    logger.info("=" * 80)
    logger.info("ARCH-013 & ARCH-014: Playbook Demo & Golden Thread Verification")
    logger.info("=" * 80)
    logger.info(f"Playbook: {playbook_id}")
    logger.info(f"Output directory: {output_dir}")
    if goal:
        logger.info(f"Mission/Goal: {goal}")
    logger.info("=" * 80)

    try:
        # Initialize PlaybookRunner
        logger.info("\nüì¶ Initializing PlaybookRunner...")
        runner = PlaybookRunner()

        # Load the registry
        logger.info("\nüìö Loading playbook registry...")
        runner.load_registry()

        # Check what playbooks are available
        available = runner.registry.list()
        logger.info(f"Found {len(available)} playbooks in registry:")
        for pb in available:
            logger.info(f"  - {pb.id}: {pb.name}")

        # Try to run the playbook
        logger.info(f"\nüöÄ Running playbook: {playbook_id}")

        # Check if it's a registry ID or file path
        playbook_path = Path(playbook_id)
        if playbook_path.exists() and playbook_path.is_file():
            # Load from file
            logger.info(f"Loading from file: {playbook_path}")
            project_context = {"goal": goal} if goal else None
            result = runner.run_playbook_file(playbook_path, project_context)
        else:
            # Try registry
            project_context = {"goal": goal} if goal else None
            result = runner.run_playbook(playbook_id, project_context)

        # ARCH-014: Dogfooding - If feature-implement playbook with vibe-standup goal, generate the tool
        if playbook_id == "feature-implement" and goal and "vibe-standup" in goal.lower():
            logger.info(
                "\nüöÄ ARCH-014: DOGFOODING - Generating bin/vibe-standup.py from mission..."
            )
            standup_script = generate_vibe_standup(goal)
            standup_path = project_root / "bin" / "vibe-standup.py"
            standup_path.parent.mkdir(parents=True, exist_ok=True)
            with open(standup_path, "w") as f:
                f.write(standup_script)
            standup_path.chmod(0o755)  # Make executable
            logger.info(f"‚úÖ Generated: {standup_path}")

        # Display results
        logger.info("\n" + "=" * 80)
        logger.info("EXECUTION RESULTS")
        logger.info("=" * 80)

        print(f"\n‚úÖ Playbook Status: {result['status'].upper()}")
        print(f"   Playbook: {result['playbook_name']}")
        print(f"   Phases executed: {len(result['phases_executed'])}")

        if result.get("phases_executed"):
            print("\nüìã Phase Execution Details:")
            for i, phase in enumerate(result["phases_executed"], 1):
                print(f"  {i}. {phase['phase_name']}")
                print(f"     Status: {phase['status']}")
                print(f"     Agents: {', '.join(phase['agents_activated'])}")
                if phase.get("tools_activated"):
                    print(f"     Tools: {', '.join(phase['tools_activated'])}")

        if result.get("errors"):
            print("\n‚ùå Errors:")
            for error in result["errors"]:
                print(f"  - {error}")

        # Save results to file
        results_file = output_dir / f"{playbook_id}_results.json"
        with open(results_file, "w") as f:
            json.dump(result, f, indent=2)
        logger.info(f"\nüíæ Results saved to: {results_file}")

        # Print summary
        logger.info("\n" + "=" * 80)
        logger.info("SUMMARY")
        logger.info("=" * 80)
        logger.info(f"‚úÖ Playbook execution: {result['status'].upper()}")
        logger.info(f"üì¶ Playbook ID: {result['playbook_id']}")
        logger.info(f"üìä Phases: {len(result['phases_executed'])}")
        logger.info(f"üíæ Results saved to: {results_file}")

        # Show execution history
        history = runner.get_execution_history()
        logger.info(f"üîÑ Total executions in session: {len(history)}")

        logger.info("\n" + "=" * 80)
        logger.info("‚ú® ARCH-013 & ARCH-014: Demo complete!")
        logger.info("   ‚úì Cartridge Slot mechanism (ARCH-013) works!")
        if playbook_id == "feature-implement" and goal and "vibe-standup" in goal.lower():
            logger.info("   ‚úì Golden Thread Verification (ARCH-014) successful!")
            logger.info("   ‚úì bin/vibe-standup.py generated and executable!")
        logger.info("=" * 80)

        return 0 if result["status"] == "success" else 1

    except PlaybookError as e:
        logger.error(f"\n‚ùå Playbook Error: {e}")
        logger.info("\n" + "=" * 80)
        logger.info("Available playbooks:")
        runner = PlaybookRunner()
        runner.load_registry()
        for pb in runner.registry.list():
            logger.info(f"  - {pb.id}: {pb.name}")
        logger.info("=" * 80)
        return 1

    except Exception as e:
        logger.error(f"\n‚ùå Unexpected error: {e}")
        import traceback

        traceback.print_exc()
        return 1


if __name__ == "__main__":
    sys.exit(main())
