#!/usr/bin/env python3
"""
bin/vibe-standup: Daily Standup Analysis Tool
==============================================

Autonomous tool generated by VIBE Agency Playbook Engine (ARCH-014).
Generated by: feature-implement playbook with vibe-standup mission.

This tool performs a 'Daily Standup' analysis:
1. Scan git log for last 24 hours
2. Summarize files changed
3. Print a motivation quote
4. Save report to daily_update.md
"""

import subprocess
import json
import sys
from pathlib import Path
from datetime import datetime, timedelta
import random

# Motivation quotes for standups
MOTIVATION_QUOTES = [
    "Code is poetry written for machines. Make it beautiful.",
    "Every bug fixed is a victory. Every test passed is progress.",
    "Refactoring today prevents firefighting tomorrow.",
    "Clean code is written so that another person can understand it. Be that person.",
    "The best code is the code that doesn't need to be debugged.",
    "Don't just write code. Write stories that computers understand.",
    "Today's debugging is tomorrow's story.",
]


def get_git_log_24h():
    """Get git log entries from the last 24 hours."""
    try:
        since = (datetime.now() - timedelta(hours=24)).isoformat()
        result = subprocess.run(
            ["git", "log", f"--since={since}", "--oneline"],
            capture_output=True,
            text=True,
            check=False,
        )
        if result.returncode == 0:
            return result.stdout.strip().split("\n") if result.stdout.strip() else []
        return []
    except Exception as e:
        print(f"âš ï¸  Error reading git log: {e}")
        return []


def get_files_changed_24h():
    """Get list of files changed in the last 24 hours."""
    try:
        since = (datetime.now() - timedelta(hours=24)).isoformat()
        result = subprocess.run(
            ["git", "diff", "--name-only", f"--since={since}"],
            capture_output=True,
            text=True,
            check=False,
        )
        if result.returncode == 0:
            files = result.stdout.strip().split("\n") if result.stdout.strip() else []
            return [f for f in files if f]  # Remove empty strings
        return []
    except Exception as e:
        print(f"âš ï¸  Error reading changed files: {e}")
        return []


def get_motivation_quote():
    """Return a random motivation quote."""
    return random.choice(MOTIVATION_QUOTES)


def save_report(report_content: str):
    """Save standup report to daily_update.md."""
    output_file = Path("daily_update.md")
    try:
        with open(output_file, "w") as f:
            f.write(report_content)
        print(f"âœ… Report saved to: {output_file}")
        return True
    except Exception as e:
        print(f"âŒ Error saving report: {e}")
        return False


def main():
    """Main standup analysis function."""
    print("=" * 70)
    print("ðŸš€ VIBE Agency - Daily Standup Analysis")
    print("=" * 70)

    # Get data
    commits = get_git_log_24h()
    files_changed = get_files_changed_24h()
    quote = get_motivation_quote()

    # Build report
    report = []
    report.append("# Daily Standup Report\n")
    report.append(f"**Generated:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
    report.append(f"**Reporting Period:** Last 24 hours\n\n")

    # Section: Git Activity
    report.append("## ðŸ“Š Git Activity (Last 24 Hours)\n")
    if commits:
        report.append(f"**Total Commits:** {len(commits)}\n\n")
        report.append("**Recent Commits:**\n")
        for commit in commits[:10]:  # Show last 10
            report.append(f"- {commit}\n")
        if len(commits) > 10:
            report.append(f"\n... and {len(commits) - 10} more commits\n")
    else:
        report.append("No commits in the last 24 hours.\n")

    report.append("\n")

    # Section: Files Changed
    report.append("## ðŸ“ Files Changed\n")
    if files_changed:
        report.append(f"**Total Files Modified:** {len(files_changed)}\n\n")
        report.append("**Files:**\n")
        for file in sorted(files_changed)[:20]:  # Show first 20
            report.append(f"- `{file}`\n")
        if len(files_changed) > 20:
            report.append(f"\n... and {len(files_changed) - 20} more files\n")
    else:
        report.append("No files changed in the last 24 hours.\n")

    report.append("\n")

    # Section: Motivation
    report.append("## ðŸ’¡ Daily Thought\n")
    report.append(f"> {quote}\n\n")

    # Section: Summary
    report.append("---\n")
    report.append("\n**Tool:** Autonomously generated by VIBE Agency Playbook Engine\n")
    report.append("**Architecture:** ARCH-014 Golden Thread Verification\n")

    report_content = "".join(report)

    # Print to console
    print("\n" + report_content)

    # Save to file
    if save_report(report_content):
        print("\n" + "=" * 70)
        print("âœ… Daily standup analysis complete!")
        print("=" * 70)
        return 0
    else:
        return 1


if __name__ == "__main__":
    sys.exit(main())
