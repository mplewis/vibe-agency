#!/bin/bash
################################################################################
# vibe-shell: VIBE AGENCY RUNTIME KERNEL
################################################################################
#
# Purpose: The execution wrapper for all agent interactions.
#
# Features:
#   - Unavoidable MOTD (displays to stderr, can't be piped away)
#   - Context Injection (loads .vibe/runtime/context.json)
#   - Command Logging (tracks all executions)
#   - Layer Detection (determines execution context)
#   - Security Enforcement (validates operations)
#
# Usage:
#   vibe-shell [COMMAND] [ARGS...]
#   vibe-shell --version
#   vibe-shell --help
#
################################################################################

set -euo pipefail

# ============================================================================
# VERSION & METADATA
# ============================================================================

VIBE_SHELL_VERSION="1.0.0-alpha"
VIBE_SHELL_DATE="2025-11-19"

# Determine VIBE_ROOT
VIBE_ROOT="${VIBE_ROOT:=$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)}"
export VIBE_ROOT

VIBE_RUNTIME_DIR="$VIBE_ROOT/.vibe/runtime"
VIBE_LOGS_DIR="$VIBE_ROOT/.vibe/logs"
VIBE_CONTEXT_FILE="$VIBE_RUNTIME_DIR/context.json"
VIBE_COMMAND_LOG="$VIBE_LOGS_DIR/commands.log"

# ============================================================================
# UTILITIES
# ============================================================================

# Print MOTD to stderr (unavoidable)
print_motd() {
    cat >&2 << 'EOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      ðŸš€ VIBE AGENCY OS SHELL ðŸš€                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF

    # Show layer detection from context (GAD-502: Context Projection)
    if [ -f "$VIBE_CONTEXT_FILE" ]; then
        LAYER=$(grep -o '"layer":"[^"]*' "$VIBE_CONTEXT_FILE" | cut -d'"' -f4 || echo "UNKNOWN")
        USER_CTX=$(grep -o '"user":"[^"]*' "$VIBE_CONTEXT_FILE" | cut -d'"' -f4 || echo "unknown")
        echo "ðŸ“ Layer: $LAYER | ðŸ‘¤ User: $USER_CTX" >&2
    else
        echo "âš ï¸  Context not initialized" >&2
    fi

    echo "" >&2
}

# Load environment from .env if present
load_env() {
    if [ -f "$VIBE_ROOT/.env" ]; then
        # shellcheck disable=SC2046
        export $(grep -v '^#' "$VIBE_ROOT/.env" | xargs)
    fi
}

# Initialize runtime directories
init_runtime() {
    mkdir -p "$VIBE_RUNTIME_DIR"
    mkdir -p "$VIBE_LOGS_DIR"

    # Create context.json if it doesn't exist
    if [ ! -f "$VIBE_CONTEXT_FILE" ]; then
        cat > "$VIBE_CONTEXT_FILE" << EOF
{
  "version": 1,
  "layer": "RUNTIME",
  "initialized_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "vibe_root": "$VIBE_ROOT",
  "hostname": "$(hostname)",
  "user": "$(whoami)"
}
EOF
    fi
}

# Log command execution with context (GAD-503: Logging Kernel)
log_command() {
    local cmd="$*"
    local timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)
    local exit_code=$?

    # Ensure logs directory exists
    mkdir -p "$VIBE_LOGS_DIR"

    # Extract context metadata if available
    local layer="RUNTIME"
    local user="$(whoami)"
    local hostname="$(hostname)"

    if [ -f "$VIBE_CONTEXT_FILE" ]; then
        layer=$(grep -o '"layer":"[^"]*' "$VIBE_CONTEXT_FILE" | cut -d'"' -f4 || echo "RUNTIME")
        user=$(grep -o '"user":"[^"]*' "$VIBE_CONTEXT_FILE" | cut -d'"' -f4 || echo "$(whoami)")
    fi

    # Write structured log entry (JSON for parsing)
    cat >> "$VIBE_COMMAND_LOG" << EOF
{"timestamp":"$timestamp","layer":"$layer","user":"$user","hostname":"$hostname","command":"$cmd","exit_code":$exit_code}
EOF
}

# Inject context into environment (GAD-502: Context Projection)
inject_context() {
    if [ -f "$VIBE_CONTEXT_FILE" ]; then
        export VIBE_CONTEXT="$(cat "$VIBE_CONTEXT_FILE")"

        # Debug mode: Show context is loaded
        if [ "${VIBE_SHELL_DEBUG:-0}" = "1" ]; then
            echo "[DEBUG] VIBE_CONTEXT loaded: $(echo "$VIBE_CONTEXT" | head -c 60)..." >&2
        fi
    fi
}

# ============================================================================
# COMMAND HANDLERS
# ============================================================================

handle_version() {
    cat << EOF
vibe-shell $VIBE_SHELL_VERSION
Build Date: $VIBE_SHELL_DATE
vibe_root: $VIBE_ROOT
EOF
}

handle_help() {
    cat << EOF
VIBE AGENCY RUNTIME KERNEL

Usage: vibe-shell [COMMAND] [ARGS...]

Commands:
  --version          Show version information
  --help             Show this help message
  --status           Show runtime status
  --health           Run system health check (Anti-Decay mechanism)
  [COMMAND] [ARGS]   Execute command with context injection

Environment:
  VIBE_ROOT          Set root directory (auto-detected if not set)
  VIBE_CONTEXT       Runtime context (auto-loaded)
  VIBE_SHELL_DEBUG   Set to 1 for debug output

Examples:
  vibe-shell python script.py
  vibe-shell bash -c 'echo \$VIBE_CONTEXT'
  vibe-shell --health
  vibe-shell --version

For more info: https://vibe-agency.dev/shell
EOF
}

handle_status() {
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" >&2
    echo "â•‘                      VIBE SHELL RUNTIME STATUS                            â•‘" >&2
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >&2
    echo "" >&2
    echo "ðŸ“¦ Version: $VIBE_SHELL_VERSION" >&2
    echo "ðŸ“ Root: $VIBE_ROOT" >&2
    echo "â° Initialized: $(date)" >&2

    if [ -f "$VIBE_CONTEXT_FILE" ]; then
        echo "âœ… Context: Loaded" >&2
        echo "   $(head -1 "$VIBE_CONTEXT_FILE" | cut -c1-70)..." >&2
    else
        echo "âŒ Context: Not found" >&2
    fi

    if [ -f "$VIBE_COMMAND_LOG" ]; then
        COMMANDS=$(wc -l < "$VIBE_COMMAND_LOG")
        echo "ðŸ“ Commands logged: $COMMANDS" >&2
    else
        echo "ðŸ“ Commands logged: 0" >&2
    fi

    echo "" >&2
}

# System health check (Anti-Decay Mechanism)
handle_health() {
    local health_status=0
    local checks_passed=0
    local checks_total=0

    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" >&2
    echo "â•‘                    VIBE SHELL HEALTH CHECK (Anti-Decay)                   â•‘" >&2
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >&2
    echo "" >&2

    # Check 1: Config exists
    checks_total=$((checks_total + 1))
    if [ -f "$VIBE_ROOT/.vibe/config/roadmap.yaml" ]; then
        echo "âœ… Config: .vibe/config/roadmap.yaml exists" >&2
        checks_passed=$((checks_passed + 1))
    else
        echo "âŒ Config: .vibe/config/roadmap.yaml MISSING" >&2
        health_status=1
    fi

    # Check 2: State exists
    checks_total=$((checks_total + 1))
    if [ -f "$VIBE_ROOT/.vibe/state/active_mission.json" ]; then
        echo "âœ… State: .vibe/state/active_mission.json exists" >&2
        checks_passed=$((checks_passed + 1))
    else
        echo "âŒ State: .vibe/state/active_mission.json MISSING" >&2
        health_status=1
    fi

    # Check 3: Logs writable
    checks_total=$((checks_total + 1))
    if mkdir -p "$VIBE_LOGS_DIR" && [ -w "$VIBE_LOGS_DIR" ]; then
        echo "âœ… Logs: .vibe/logs/ is writable" >&2
        checks_passed=$((checks_passed + 1))
    else
        echo "âŒ Logs: .vibe/logs/ is NOT writable" >&2
        health_status=1
    fi

    # Check 4: VirtualEnv active
    checks_total=$((checks_total + 1))
    if [ -n "${VIRTUAL_ENV:-}" ]; then
        echo "âœ… VirtualEnv: Active ($(basename $VIRTUAL_ENV))" >&2
        checks_passed=$((checks_passed + 1))
    else
        echo "âš ï¸  VirtualEnv: Not active (optional, but recommended)" >&2
    fi

    # Check 5: Mission CLI reachable
    checks_total=$((checks_total + 1))
    if python3 "$VIBE_ROOT/bin/mission" status > /dev/null 2>&1; then
        echo "âœ… Steward: Mission control reachable" >&2
        checks_passed=$((checks_passed + 1))
    else
        echo "âŒ Steward: Mission control NOT reachable" >&2
        health_status=1
    fi

    echo "" >&2
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
    echo "Health: $checks_passed/$checks_total checks passed" >&2
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2

    if [ $health_status -eq 0 ]; then
        echo "ðŸŸ¢ SYSTEM HEALTHY: All critical checks passed" >&2
    else
        echo "ðŸ”´ SYSTEM DEGRADED: Critical checks failed - system may be unstable" >&2
    fi
    echo "" >&2

    return $health_status
}

# ============================================================================
# MAIN EXECUTION
# ============================================================================

main() {
    # Always print MOTD (unavoidable)
    print_motd

    # Initialize runtime
    init_runtime
    load_env
    inject_context

    # Handle special flags
    case "${1:-}" in
        --version)
            handle_version
            exit 0
            ;;
        --help|-h)
            handle_help
            exit 0
            ;;
        --status)
            handle_status
            exit 0
            ;;
        --health)
            handle_health
            exit $?
            ;;
        -c)
            # Shell command mode (like bash -c)
            if [ $# -gt 1 ]; then
                shift  # Remove -c flag
                log_command "$@"
                exec "${SHELL:-/bin/bash}" -c "$@"
            else
                echo "Error: -c requires a command" >&2
                exit 1
            fi
            ;;
        *)
            # Execute command with arguments if provided
            if [ $# -gt 0 ]; then
                log_command "$@"
                exec "$@"
            else
                # No command provided - drop into interactive shell (if possible)
                if [ -t 0 ]; then
                    # Interactive terminal
                    PS1="(vibe-shell) $ " exec "${SHELL:-/bin/bash}"
                else
                    # Non-interactive - just exit
                    echo "Error: No command provided and non-interactive mode" >&2
                    exit 1
                fi
            fi
            ;;
    esac
}

# Run main
main "$@"
